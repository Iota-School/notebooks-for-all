{#
this notebook template represents cells as a feed pattern of complex forms.
it is designed with aria in mind, all possible aria is included. the resting, or static, state
of the notebook is represented here. features are progressively added by flipping different aria switches.

we make no distinction between markdown and code cells. in fact, they are synthesized by adds draggable, multiselectable
tabs
in the input area.

for optimal aria support, we wrap input cells in a figure tag so that the figcaption can become the aria-describedby
reference.

#}
{%- extends 'semantic-forms/base.html.j2' -%}
`
{%- block header -%}
<html lang="en">

<head>
    <title></title>
    <style>
        {% include "semantic-forms/static/style.css" %}
    </style>
</head>
{%- endblock header -%}


{%- block body -%}

<body>
    <nav class="skip" aria-label="skip links">
        <a class="skip sro" tabindex="0" href="#cells">Skip to content</a>
        <a class="skip sro" tabindex="0" href="#header" onclick="document.getElementById('toc').open = true">Skip to header</a>
        <a class="skip sro" tabindex="0" href="#footer">Skip to footer</a>
    </nav>
    <header id="header">
        <!-- use headers for introductory content -->
        <nav id="site" aria-label="site-navigation"></nav>
        <dialog id="settings"></dialog>
    </header>
    <div id="top"></div>
    <main class="notebook static" aria-labelledby="notebook-caption">
        <!--the notebook is main area. it is represented by a big table. -->
        <header>
            <nav aria-label="table of contents">
                <details id="toc"><summary>table of contents</summary></details>
            </nav>
            <!--this is generated from the dom. sure these is a resting state, but this should probably in the javascript so its updates when interactive.-->
        </header>
        {{metadata_dialog(metadata)}}
        <!-- metadata is NOT introductory content, and it is supplemental, it is NOT complementary -->
        <!-- metadata is colorless at rest so we place it in a dialog that can be revealed by the user -->
        <table class="cells" id="cells">
            {# aria-label="{{title}}" #}
            <thead>
                <tr class="cell header">
                    {# <th class="index" scope="col">index</th> #}
                    {# we dont need to keep the index because the table manages that for us. #}
                    <th class="execution_count" scope="col">execution count</th>
                    <th class="cell_type" scope="col">cell type</th>
                    <th class="source" scope="col">source</th>
                    <th class="outputs" scope="col">outputs</th>
                    <th class="metadata" scope="col">metadata</th>
                </tr>
            </thead>
            <tbody>
                {% for i, cell in enumerate(nb.cells) %}
                {{cell_form(cell_type=cell.cell_type, source=cell.source, id=cell.id, metadata=cell.metadata,
                outputs=cell.outputs,
                execution_count=cell.execution_count, count=i, total_count=len(cells), cell=cell)}}
                {% endfor %}
            </tbody>
            <tfoot>
                <tr></tr>
            </tfoot>
            <caption id="notebook-caption">{{resources.metadata.path}}/{{resources.metadata.name}}.ipynb</caption>
        </table>
    </main>
    <footer id="footer">
        <table class="summary"></table>
        <a href="#top">Scroll to top</a>
    </footer>
</body>
{%- endblock body -%}

{%- block footer -%}

</html>
{%- endblock footer -%}


{% macro highlight(body, type) %}
{{body}}
{% endmacro %}

{% macro metadata_dialog(metadata) %}
{% endmacro %}

{% macro cell_form(cell_type, count=0, total_count=1, id="", execution_count="", source="", outputs="", metadata=None,
cell=cell)
%}
{% set metadata = metadata or {} %}
{% set count = count + 1 %}
{% set source = "".join(source) %}
{% set FORM = "cell-form-" + str(id or count) %}

<tr class="cell {{cell_type}}" id="cell-{{count}}" draggable="false" aria-busy="false">
    <td class="execution_count" id="{{FORM}}-exec">{{execution_count}}</td>
    <td class="cell_type">
        <label class="cell_type">
            <select name="cell_type" disabled>
                <option {% if cell_type=="code" %}selected{% endif %} value="code">code</option>
                <option {% if cell_type=="markdown" %}selected{% endif %} value="markdown">markdown</option>
                <option {% if cell_type=="raw" %}selected{% endif %} value="raw">raw</option>
                <option {% if cell_type=="unknown" %}selected{% endif %} value="unknown">unknown</option>
            </select> cell
        </label>
    </td>
    <td class="source">
        <form id="{{FORM}}" aria-label="{{cell_type}} cell {{count}}">
            <textarea readonly class="sro" name="source" id="{{FORM}}-source" aria-hidden="false" autocomplete="off"
                autocorrect="off" placeholder="" spellcheck="default" rows="{{len(source.rstrip().splitlines())}}"
                aria-labelledby="{{FORM}}-exec" wrap="soft">{{source}}</textarea>
            <div class="render" aria-hidden="{% if cell_type == "markdown" %}false{% else %}true{% endif %}">
                {% if cell_type=="markdown" %}{{markdown(source)}}{% endif %}
                {% if cell_type=="code" %}{{markdown("```IPython3\n"+"".join(source)+"\n```\n")}}{% endif %}
            </div>
            <input type="submit" for="{{FORM}}-source" value="run" title="run the cell" class="sro" tabindex="0">
        </form>
    </td>
    <td class="outputs">
        {% for i, output in enumerate(outputs) %}
        {% block output scoped %}{% block output_prompt %}{% endblock %}{{super()}}{% endblock %}
        {% endfor %}
    </td>
    <td class="metadata">
        <dialog class="metadata" id="cell-metadata-{{count}}">
            <figure>
                <div role="tablist" aria-multiselectable="true">
                    <button class="plain" aria-selected="false" aria-controls="cell-metadata-plain-{{count}}"
                        tabindex="-1"></button>
                    <button class="render" aria-selected="true" aria-controls="cell-metadata-render-json-{{count}}"
                        tabindex="-1"></button>
                </div>
                <textarea name="metadata" id="cell-metadata-plain-{{count}}" aria-hidden="false" autocomplete="off"
                    autocorrect="off" form="{{id}}" placeholder="" spellcheck="default"
                    wrap="soft">{{json.dumps(metadata)}}</textarea>
                <figure id="cell-metadata-render-json-{{count}}">
                    {{highlight(json.dumps(metadata), cell_type)}}
                    <figcaption></figcaption>
                </figure>
                <figcaption id="cell-metadata-description-{{i}}"></figcaption>
            </figure>
        </dialog>
    </td>

</tr>
{% endmacro %}

{#
<footer>
    <label class="start_time">
        <output><time></time></output>
    </label>
    <label class="end_time">
        <output><time></time></output>
    </label>
    <label class="elapsed_time">
        <output><time></time></output>
    </label>
</footer> #}