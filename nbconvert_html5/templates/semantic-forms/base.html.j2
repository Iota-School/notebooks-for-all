{%- extends 'display_priority.j2' -%}
{% from 'celltags.j2' import celltags %}

{% block execute_result -%}
{%- set extra_class="output_execute_result" -%}
{% block data_priority scoped %}
{{ super() }}
{% endblock data_priority %}
{%- set extra_class="" -%}
{%- endblock execute_result %}

{% block stream_stdout -%}
<pre class="stdout">
<code>{{- output.text -}}</code>
</pre>
{%- endblock stream_stdout %}

{% block stream_stderr -%}
<pre class="stdout">
<code>{{- output.text -}}</code>
</pre>
{%- endblock stream_stderr %}

{% block data_svg scoped -%}
{# <figure class="svg"> #}
{%- if output.svg_filename %}
<img src="{{ output.svg_filename | posix_path | escape_html }}">
{%- else %}
{{ output.data['image/svg+xml'].encode("utf-8") | clean_html }}
{%- endif %}
{# </figure> #}
{%- endblock data_svg %}

{% block data_html scoped -%}
{%- if resources.should_sanitize_html %}
{%- set html_value=output.data['text/html'] | clean_html -%}
{%- else %}
{%- set html_value=output.data['text/html'] -%}
{%- endif %}
{%- if output.get('metadata', {}).get('text/html', {}).get('isolated') -%}
<iframe
    class="isolated-iframe"
    style="height:520px; width:100%; margin:0; padding: 0"
    frameborder="0"
    scrolling="auto"
    src="data:text/html;base64,{{ html_value | text_base64 }}">
</iframe>
{%- else -%}
{{ html_value }}
{%- endif -%}
{%- endblock data_html %}

{% block data_markdown scoped -%}
{%- if resources.should_sanitize_html %}
{%- set html_value=output.data['text/markdown'] | markdown2html | clean_html -%}
{%- else %}
{%- set html_value=output.data['text/markdown'] | markdown2html -%}
{%- endif %}
{{ html_value }}
{%- endblock data_markdown %}

{% block data_png scoped %}
{# <figure class="png"> #}
{%- if 'image/png' in output.metadata.get('filenames', {}) %}
<img src="{{ output.metadata.filenames['image/png'] | posix_path | escape_html }}"
{%- else %}
<img src="data:image/png;base64,{{ output.data['image/png'] | escape_html }}"
{%- endif %}
{%- set width=output | get_metadata('width', 'image/png') -%}
{%- if width is not none %}
width={{ width | escape_html }}
{%- endif %}
{%- set height=output | get_metadata('height', 'image/png') -%}
{%- if height is not none %}
height={{ height | escape_html }}
{%- endif %}
{%- if output | get_metadata('unconfined', 'image/png') %}
class="unconfined"
{%- endif %}
{%- set alttext=(output | get_metadata('alt', 'image/png')) or (cell | get_metadata('alt')) -%}
{%- if alttext is not none %}
alt="{{ alttext | escape_html }}"
{%- endif %}
>
{# </figure> #}
{%- endblock data_png %}

{% block data_jpg scoped %}
{# <figure class="jpeg jpg"> #}
{%- if 'image/jpeg' in output.metadata.get('filenames', {}) %}
<img src="{{ output.metadata.filenames['image/jpeg'] | posix_path | escape_html }}"
{%- else %}
<img src="data:image/jpeg;base64,{{ output.data['image/jpeg'] | escape_html }}"
{%- endif %}
{%- set width=output | get_metadata('width', 'image/jpeg') -%}
{%- if width is not none %}
width={{ width | escape_html }}
{%- endif %}
{%- set height=output | get_metadata('height', 'image/jpeg') -%}
{%- if height is not none %}
height={{ height | escape_html }}
{%- endif %}
{%- if output | get_metadata('unconfined', 'image/jpeg') %}
class="unconfined"
{%- endif %}
{%- set alttext=(output | get_metadata('alt', 'image/jpeg')) or (cell | get_metadata('alt')) -%}
{%- if alttext is not none %}
alt="{{ alttext | escape_html }}"
{%- endif %}
>
{# </figure> #}
{%- endblock data_jpg %}

{% block data_latex scoped %}
{# <figure class="latex"> #}
{{ output.data['text/latex'] | e }}
{# </figure> #}
{%- endblock data_latex %}

{% block error -%}
<pre class="exception">
{{- super() -}}
</pre>
{%- endblock error %}

{%- block traceback_line %}
{{ line | ansi2html }}
{%- endblock traceback_line %}

{%- block data_text scoped %}
<pre class="plain">
{{- output.data['text/plain'] | ansi2html -}}
</pre>
{%- endblock -%}

{%- block data_javascript scoped %}
{% set div_id = uuid4() %}
<div id="{{ div_id }}" class="output_subarea output_javascript {{ extra_class }}">
{%- if not resources.should_sanitize_html %}
<script type="text/javascript">
var element = $('#{{ div_id }}');
{{ output.data['application/javascript'] }}
</script>
{%- endif %}
</div>
{%- endblock -%}

{%- block data_widget_view scoped %}
{%- if not resources.should_sanitize_html %}
{% set div_id = uuid4() %}
{% set datatype_list = output.data | filter_data_type %}
{% set datatype = datatype_list[0]%}
<div id="{{ div_id }}" class="output_subarea output_widget_view {{ extra_class }}">
<script type="text/javascript">
var element = $('#{{ div_id }}');
</script>
<script type="{{ datatype }}">
{{ output.data[datatype] | json_dumps | escape_html }}
</script>
</div>
{%- endif %}
{%- endblock data_widget_view -%}

{%- block footer %}
{%- if not resources.should_sanitize_html %}
{% set mimetype = 'application/vnd.jupyter.widget-state+json'%}
{% if mimetype in nb.metadata.get("widgets",{})%}
<script type="{{ mimetype }}">
{{ nb.metadata.widgets[mimetype] | json_dumps | escape_html }}
</script>
{% endif %}
{%- endif %}
{{ super() }}
{%- endblock footer-%}



{% macro cell_form(cell, nb) %}
{% set count = nb["cells"].index(cell) +1%}
{% set ID = "/cells/" + str(cell.id or count) %}
<form id="{{ID}}" aria-label="Cell Source {{count}}">
    {{cell_type_cell(cell)}}
    <label>
        <textarea name="source" id="{{ID}}/source" readonly>{{cell.source}}</textarea>
    </label>
</form>
{{cell_toolbar(cell, ID)}}
<output class="render" for="{{ID}}/source" form={{ID}} aria-hidden="{% if cell.cell_type == "markdown" %}false{% else %}true{% endif %}">
    {% if cell.cell_type=="markdown" %}{{markdown(cell.source) | strip_files_prefix}}{% endif %}
    {% if cell.cell_type=="code" %}{{ cell.source | highlight_code(metadata=cell.metadata) }}{% endif %}
</output>
<output form={{ID}} for="{{ID}}/source" name=execution_count id="{{ID}}/outputs">{{cell.execution_count or ""}}</output>
<output form={{ID}} for="{{ID}}/source" name=outputs role=log>{{outputs_cell(cell, ID)}}</output>
{% endmacro%}

{% macro cell_type_cell(cell) %}
{% set cell_type = cell.cell_type %}
<label class="cell_type">
    <select name="cell_type" disabled>
        <option {% if cell_type=="code" %}selected{% endif %} value="code">code</option>
        <option {% if cell_type=="markdown" %}selected{% endif %} value="markdown">markdown</option>
        <option {% if cell_type=="raw" %}selected{% endif %} value="raw">raw</option>
        <option {% if cell_type=="unknown" %}selected{% endif %} value="unknown">unknown</option>
    </select>
</label>
{% endmacro %}

{% macro outputs_cell(cell, ID) %}
{% for i, output in enumerate(cell.outputs) %}
{% block output scoped %}{% block output_prompt %}{% endblock %}{{super()}}{% endblock %}
{% endfor %}
{% endmacro %}


{% macro cell_toolbar(cell, ID) %}
<menu class="cell toolbar" hidden>
    <input class="run" type="submit" form="{{ID}}" for="{{ID}}-source" value="run" title="run the cell"
        tabindex="0">
    <button onclick="document.querySelector('#{{ID}}-metadata').showModal()" title="show metadata">ðŸ›ˆ</button>
</menu>
{% endmacro %}

{% macro hide(x) %}{% if not x %}hidden{% endif %}{% endmacro %}


{% macro highlight(body, type) %}
{{markdown("```{{type}}\n" + json.dumps(nb.metadata, indent=2) + "\n```\n")}}
{% endmacro %}